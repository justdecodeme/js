<!doctype html>

<title>Brick Breakout Game</title>
<style>
canvas {
  background: lightblue;
  margin: 0 auto;
}
</style>

<canvas id="canvas" width="600" height="300"></canvas>
<p id="current">0</p>
<p id="highest">0</p>

<script>
  // Variables
  var canvas = document.getElementById('canvas');
  var ctx = canvas.getContext('2d');
  var cw = canvas.width;
  var ch = canvas.height;
  var totalBricks, leftPressed = rightPressed = false, score = 0;

  if(localStorage.highest) {
    document.getElementById('highest').innerHTML = localStorage.highest;
  } else {
    localStorage.highest = 0;
  }

  var ball = {x: cw/2, y: 50, r: 10, vx: 1, vy: -1};
  var paddle = {x: 100, y: 100, w: 100, h: 10};
  var brick = {x: 200, y: 200, w: 100, h: 10, row: 3, col: 4, gapBtwn: 15, gapTop: 30, gapLeftRight: 30 };
  ball.y = ch-2*ball.r;
  paddle.x = cw/2 - paddle.w/2;
  paddle.y = ch - paddle.h;
  totalBricks = brick.row * brick.col;
  brick.w = (cw - 2*brick.gapLeftRight - (brick.col-1)*brick.gapBtwn) / brick.col;

  document.addEventListener('keydown', keydownHandler);
  document.addEventListener('keyup', keyupHandler);

  function keydownHandler(e) {
    if(e.keyCode == 37) {
      leftPressed = true;
    } else if(e.keyCode == 39) {
      rightPressed = true;
    }
  }
  function keyupHandler(e) {
    leftPressed = rightPressed = false;
  }

  function initBricks() {
    bricks = [];
    for(var r = 0; r < brick.row; r++) {
      bricks[r] = [];
      for(var c = 0; c < brick.col; c++) {
        bricks[r][c] = {x: 0, y: 0, status: 'visible'};
        bricks[r][c].x = brick.gapLeftRight + c * (brick.w + brick.gapBtwn);
        bricks[r][c].y = brick.gapTop + r * (brick.h + brick.gapBtwn);
      }
    }
  }

  function drawBricks() {
    for(var r = 0; r < brick.row; r++) {
      for(var c = 0; c < brick.col; c++) {
        if(bricks[r][c].status == 'visible') {
          ctx.beginPath();
          ctx.rect(bricks[r][c].x, bricks[r][c].y, brick.w, brick.h);
          ctx.fillStyle = 'blue';
          ctx.fill();
        }
      }
    }
  }

  function drawBall() {
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, 2*Math.PI);
    ctx.fillStyle = 'red';
    ctx.fill();
  }

  function drawPaddle() {
    ctx.beginPath();
    ctx.rect(paddle.x, paddle.y, paddle.w, paddle.h);
    ctx.fillStyle = "black";
    ctx.fill();
  }

  function collisionDetection() {
// BALL AND BRICKS
    for (var r = 0; r < brick.row; r++) {
      for ( var c = 0; c < brick.col; c++) {
        if(bricks[r][c].status == 'visible') {
          if(ball.x > bricks[r][c].x && ball.x < bricks[r][c].x + brick.w && ball.y > bricks[r][c].y && ball.y < bricks[r][c].y + brick.h) {
            ball.vy = -ball.vy;
            bricks[r][c].status = 'hidden';
            document.getElementById('current').innerHTML = ++score;
            console.log(localStorage.highest);
            if(localStorage.highest < score) {
              localStorage.highest = score;
            }
          }
        }
      }
    }


// BALL AND WALLS
    // top and ball
    if(ball.y + ball.vy < ball.r) {
      ball.vy = -ball.vy;
      // left and right and ball
    } else if(ball.x + ball.vx < ball.r || ball.x + ball.vx > cw-ball.r) {
      ball.vx = -ball.vx;
      // bottom and ball
    } else if(ball.y + ball.vy > ch-ball.r) {
      // paddle and ball
      if(ball.x > paddle.x && ball.x < paddle.x+paddle.w) {
        ball.vy = -ball.vy;
        // ball hits the floor
      } else {
        document.location.reload();
        alert('OUTTTTTTTT');
      }
    }
    ball.x += ball.vx;
    ball.y += ball.vy;

    if(leftPressed && paddle.x > 0) {
      paddle.x -= 3;
    } else if (rightPressed && paddle.x < cw-paddle.w) {
      paddle.x += 3;
    }
  }

  initBricks();

  function initGame() {
    ctx.clearRect(0,0, cw, ch);
    drawBall();
    drawPaddle();
    drawBricks();
    collisionDetection();
  }
  initGame();
  var game_loop = setInterval(initGame, 10);
</script>
