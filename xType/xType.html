<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>xType | xLab Typing App</title>
    <style media="screen">
      #toggleTypingBtn {
          background: lightgreen;
          padding: 10px;
          cursor: pointer;
          user-select: none;
          display: inline-block;
      }
      #toggleTypingBtn.active {
        background: orange;
      }
      #typingArea {
        font-size: 70px;
      }
      .active { background: lightblue; }
      .success { color: #d5d5d5; }
      .error { background: yellow; }
    </style>
  </head>
  <body>
    <a id="toggleTypingBtn">Start Typing</a>
    <div id="timerArea">
      <h1 class="display__time-left">01:00</h1>
      <p class="display__end-time"></p>
    </div>
    <!-- container for letters -->
    <div id="typingArea"></div> <!-- {1} -->

    <script type="text/javascript">
      let isTypingEnabled, count, countdown = null;
      // string to be typed
      const str = 'js is.';
      // convert string to array
      const strArr = str.split('');
      const timerArea = document.querySelector('#timerArea');
      const timerDisplay = document.querySelector('.display__time-left');
      const endTime = document.querySelector('.display__end-time');
      const typingArea = document.querySelector('#typingArea');
      const toggleTypingBtn = document.querySelector('#toggleTypingBtn');

      // FUNCTIONS
      function displayTimeLeft(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainderSeconds = seconds % 60;
        const display = `${minutes}:${remainderSeconds < 10 ? '0' : '' }${remainderSeconds}`;
        timerDisplay.textContent = display;
      }

      function displayEndTime(timestamp) {
        console.log(timestamp)
        const end = new Date(timestamp);
        const hour = end.getHours();
        const adjustedHour = hour > 12 ? hour - 12 : hour;
        const minutes = end.getMinutes();
        endTime.textContent = `Be Back At ${adjustedHour}:${minutes < 10 ? '0' : ''}${minutes}`;
      }
      var timer = function(seconds) {
        // clear any existing timers
        clearInterval(countdown);

        const now = Date.now();
        const then = now + seconds * 1000;
        displayTimeLeft(seconds);
        displayEndTime(then);

        countdown = setInterval(() => {
          const secondsLeft = Math.round((then - Date.now()) / 1000);
          // check if we should stop it!
          if(secondsLeft < 0) {
            clearInterval(countdown);
            return;
          }
          // display it
          displayTimeLeft(secondsLeft);
        }, 1000);
      }
      var generateText = function() {
        count = 0;
        let strHTML = '';
        isTypingEnabled = false;
        // convert string array to html
        strArr.forEach(letter => {
          strHTML += `<span class="letter">${letter}</span>`
        })
        // put generated html into its container {1}
        typingArea.innerHTML = strHTML;
        // select all letters
        let letters = document.querySelectorAll('#typingArea span');
        // select last letter
        let last = document.querySelectorAll('#typingArea span')[str.length-1];
        // add active class to firt letter
        letters[0].classList.add('active');
      };
      var checkTyping = function(e) {
        // select active letter
        let active = document.querySelector('#typingArea span.active');
        // run only if typing is enabled
        if(isTypingEnabled) {
          // check if we didn't reached last letter
          if(count < str.length-1) {
            count++;
            // add active class to next element
            active.nextSibling.classList.add('active');
            // if active letter is equal to typed letter
            if(active.innerHTML == e.key) {
                active.classList.add('success');
                active.classList.remove('active');
                // if active letter is not equal to typed letter
            } else if(active.innerHTML != e.key) {
                active.classList.add('error');
                active.classList.remove('active');
            }
            // if we reached last letter
          } else {
            active.classList.remove('active');
            if(active.innerHTML == e.key) {
                active.classList.add('success');
            } else if(active.innerHTML != e.key) {
                active.classList.add('error');
            }
            setTimeout(function(){ alert("DONE!"); });
            generateText();
            toggleTypingBtn.classList.remove('active');
            toggleTypingBtn.innerHTML = 'Start Typing Again';
            document.removeEventListener('keyup', checkTyping, false);
          }
        }
      }
      var startTyping = function() {
        timer(60);
        toggleTypingBtn.classList.add('active');
        toggleTypingBtn.innerHTML = 'Stop Typing';
        document.addEventListener('keyup', checkTyping, false);
      }
      var stopTyping = function() {
        toggleTypingBtn.classList.remove('active');
        toggleTypingBtn.innerHTML = 'Start Typing';
        document.removeEventListener('keyup', checkTyping, false);
      }
      var toggleTyping = function(e) {
        // check if button is really clicked
        if(e.detail == 1) {
          // if typing is not enabled
          if(!isTypingEnabled) {
            startTyping();
            // if typing is enabled
          } else {
            stopTyping();
          }
          // toggle Typing
          isTypingEnabled = !isTypingEnabled;
        }
      }
      // EVENT LISTENERS
      generateText();
      toggleTypingBtn.addEventListener('click', toggleTyping, false);
    </script>
  </body>
</html>
